<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Valoraci√≥n entrevista</title>

<style>
:root{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#111;
  --soft:#eef0f6;

  --danger:#d32f2f;
  --warn:#f9a825;
  --ok:#2e7d32;
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0f1116;
    --card:#171a22;
    --text:#f2f4f8;
    --soft:#232737;
  }
}

html, body {
  touch-action: manipulation;
  overscroll-behavior: contain;
}

body{ margin:0; background:var(--bg); color:var(--text); }
.wrap{ max-width:520px; margin:auto; padding:16px; }
.card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.08); }

/* C√≠rculo + emoji (emoji fuera) */
.meterRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:18px;
  margin-bottom:10px;
}

/* Medidor circular */
.meter{ width:220px; height:220px; position:relative; flex:0 0 auto; }
.meter svg{ width:100%; height:100%; transform:rotate(-90deg); }
.track{ stroke:var(--soft); stroke-width:14; fill:none; }
.progress{ stroke:var(--danger); stroke-width:14; fill:none; stroke-linecap:round; transition:.2s; }

.meterCenter{
  position:absolute; inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
#total{ font-size:64px; font-weight:900; transition:.2s; line-height:1; }
#badge{ font-size:14px; opacity:.7; margin-top:8px; }

/* Emoji fuera */
#emoji{
  font-size:58px;
  transition:.2s;
  line-height:1;
  user-select:none;
}

/* Barra horizontal */
.progressBar{ height:14px; background:var(--soft); border-radius:999px; overflow:hidden; margin-bottom:16px;}
#progressFill{ height:100%; width:0%; background:var(--danger); transition:.2s; }

/* Sliders */
.row{ margin-bottom:18px; }
.rowHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.rowHeader label{ font-weight:600; }
.scoreValue{
  font-weight:700;
  min-width:64px;
  text-align:right;
  font-variant-numeric: tabular-nums;
}

input[type=range]{
  width:100%;
  height:8px;
  border-radius:999px;
  background:var(--soft);
  outline:none;
  touch-action: pan-y; /* evita gestos raros */
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:24px; height:24px;
  border-radius:50%;
  background:var(--text);
}

/* Extra +0,5 */
.extraRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 10px;
  border-radius:12px;
  background: var(--soft);
  margin: 6px 0 18px;
}
.extraRow .left{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.extraRow .title{ font-weight:700; }
.extraRow .hint{ font-size:12px; opacity:.75; }
.extraRow .right{
  display:flex;
  align-items:center;
  gap:10px;
}
.extraBadge{
  font-weight:800;
  min-width:54px;
  text-align:right;
  font-variant-numeric: tabular-nums;
}

/* Switch */
.switch{
  position:relative;
  width:52px;
  height:30px;
  flex: 0 0 auto;
}
.switch input{ display:none; }
.slider{
  position:absolute;
  cursor:pointer;
  inset:0;
  background:#b7bcc7;
  border-radius:999px;
  transition:.2s;
}
.slider:before{
  content:"";
  position:absolute;
  height:24px;
  width:24px;
  left:3px;
  top:3px;
  background:white;
  border-radius:50%;
  transition:.2s;
}
.switch input:checked + .slider{
  background: #3bb54a;
}
.switch input:checked + .slider:before{
  transform: translateX(22px);
}

button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  background:var(--soft);
  color:var(--text);
  font-weight:600;
}

/* Confeti */
#confettiCanvas{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:999;
}

/* En pantallas muy estrechas: emoji abajo */
@media (max-width: 360px){
  .meterRow{ flex-direction:column; gap:10px; }
  #emoji{ font-size:54px; }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="meterRow">
      <div class="meter">
        <svg viewBox="0 0 220 220">
          <circle class="track" cx="110" cy="110" r="92"></circle>
          <circle id="ring" class="progress" cx="110" cy="110" r="92"></circle>
        </svg>
        <div class="meterCenter">
          <div id="total">0,0</div>
          <div id="badge">0,0 / 10</div>
        </div>
      </div>
      <div id="emoji">üò¨</div>
    </div>

    <div class="progressBar">
      <div id="progressFill"></div>
    </div>

    <div id="list"></div>

    <!-- Extra +0,5 -->
    <div class="extraRow">
      <div class="left">
        <div class="title">Extra</div>
        <div class="hint">Marca +0,5 si procede</div>
      </div>
      <div class="right">
        <div class="extraBadge" id="extraBadge">0,0</div>
        <label class="switch" aria-label="Extra +0,5">
          <input id="extraToggle" type="checkbox">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <button id="reset">Reiniciar</button>

  </div>
</div>

<canvas id="confettiCanvas"></canvas>

<script>
/*
  Criterios (m√°ximos):
  - Normativa:          0,3
  - Presentaci√≥n:       1,0
  - Funciones:          3,0
  - Experiencia:        3,0
  - Experiencia SSMM:   1,5
  - Aportaci√≥n:         0,2
  - Aportaci√≥n SSMM:    0,5
  Total base:           9,5
  Extra:               +0,5 => Total m√°x: 10,0

  Internamente guardamos "d√©cimas" enteras:
  0,1 punto = 1 d√©cima.
*/

const CRITERIOS = [
  { key:"normativa",         label:"Normativa",        maxTenths:  3 }, // 0,3
  { key:"presentacion",      label:"Presentaci√≥n",     maxTenths: 10 }, // 1,0
  { key:"funciones",         label:"Funciones",        maxTenths: 30 }, // 3,0
  { key:"experiencia",       label:"Experiencia",      maxTenths: 30 }, // 3,0
  { key:"experiencia_ssmm",  label:"Experiencia SS.SS.MM.", maxTenths: 15 }, // 1,5
  { key:"aportacion",        label:"Aportaci√≥n",       maxTenths:  2 }, // 0,2
  { key:"aportacion_ssmm",   label:"Aportaci√≥n SS.SS.MM.",  maxTenths:  5 }, // 0,5
];

const EXTRA_TENTHS = 5; // +0,5
const STORE = "valoracion_confeti_v4_emoji_fuera";

const ring = document.getElementById("ring");
const totalEl = document.getElementById("total");
const emojiEl = document.getElementById("emoji");
const badge = document.getElementById("badge");
const fill = document.getElementById("progressFill");
const extraToggle = document.getElementById("extraToggle");
const extraBadge = document.getElementById("extraBadge");

const R = 92;
const C = 2*Math.PI*R;
ring.style.strokeDasharray = C;
ring.style.strokeDashoffset = C;

function format(n){ return n.toFixed(1).replace(".",","); }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

/* ========= Sonido compatible (Web Audio API) ========= */
let audioCtx = null;

function getAudioCtx(){
  const AC = window.AudioContext || window.webkitAudioContext;
  if (!AC) return null;
  if (!audioCtx) audioCtx = new AC();
  return audioCtx;
}



async function playExtraSound(){
  const ctx = getAudioCtx();
  if(!ctx) return;

  if (ctx.state === "suspended") {
    try { await ctx.resume(); } catch(e) {}
  }

  const now = ctx.currentTime;

  // Jingle "Arcade/Arkanoid-ish" (~1.3s)
  // Notas r√°pidas tipo: C6 D6 E6 G6 | E6 D6 C6 | G5 A5 B5 C6 (remate)
  const melody = [
    { f: 1046.50, d: 0.07 }, // C6
    { f: 1174.66, d: 0.07 }, // D6
    { f: 1318.51, d: 0.07 }, // E6
    { f: 1567.98, d: 0.10 }, // G6

    { f: 1318.51, d: 0.07 }, // E6
    { f: 1174.66, d: 0.07 }, // D6
    { f: 1046.50, d: 0.10 }, // C6

    { f: 783.99,  d: 0.07 }, // G5
    { f: 880.00,  d: 0.07 }, // A5
    { f: 987.77,  d: 0.07 }, // B5
    { f: 1046.50, d: 0.20 }  // C6 (remate)
  ];

  const master = ctx.createGain();
  master.gain.setValueAtTime(0.10, now);
  master.connect(ctx.destination);

  // --- Melod√≠a principal (square, staccato) ---
  let t = now;
  melody.forEach((n, i) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = "square";
    // micro slide para sabor arcade
    if(i > 0){
      const prev = melody[i-1].f;
      osc.frequency.setValueAtTime(prev, t);
      osc.frequency.exponentialRampToValueAtTime(n.f, t + 0.015);
    } else {
      osc.frequency.setValueAtTime(n.f, t);
    }

    // envolvente r√°pida (staccato), sin clicks
    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(0.65, t + 0.008);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + n.d);

    osc.connect(gain);
    gain.connect(master);

    osc.start(t);
    osc.stop(t + n.d + 0.02);

    t += n.d;
  });

  // --- Bajo "pum pum" simple (square) ---
  // Alterna C3 y G2 con ritmo r√°pido, t√≠pico arcade
  const bassPattern = [130.81, 98.00, 130.81, 98.00]; // C3, G2...
  const bassStep = 0.12;
  const totalDur = melody.reduce((a,n)=>a+n.d,0);
  const bassCount = Math.ceil(totalDur / bassStep);

  for(let i=0; i<bassCount; i++){
    const bt = now + i*bassStep;
    const bf = bassPattern[i % bassPattern.length];

    const bOsc = ctx.createOscillator();
    const bGain = ctx.createGain();

    bOsc.type = "square";
    bOsc.frequency.setValueAtTime(bf, bt);

    bGain.gain.setValueAtTime(0.0001, bt);
    bGain.gain.exponentialRampToValueAtTime(0.14, bt + 0.006);
    bGain.gain.exponentialRampToValueAtTime(0.0001, bt + 0.08);

    bOsc.connect(bGain);
    bGain.connect(master);

    bOsc.start(bt);
    bOsc.stop(bt + 0.10);
  }

  // --- ‚ÄúPing‚Äù final brillante (muy Arkanoid) ---
  const pingT = now + totalDur - 0.10;
  const ping = ctx.createOscillator();
  const pg = ctx.createGain();

  ping.type = "triangle";
  ping.frequency.setValueAtTime(2093.00, pingT); // C7
  pg.gain.setValueAtTime(0.0001, pingT);
  pg.gain.exponentialRampToValueAtTime(0.10, pingT + 0.01);
  pg.gain.exponentialRampToValueAtTime(0.0001, pingT + 0.10);

  ping.connect(pg);
  pg.connect(master);
  ping.start(pingT);
  ping.stop(pingT + 0.12);
}
/* ========= Estado ========= */
let state = (() => {
  try{
    const raw = localStorage.getItem(STORE);
    const parsed = raw ? JSON.parse(raw) : {};
    CRITERIOS.forEach(c => {
      if (typeof parsed[c.key] !== "number") parsed[c.key] = 0;
      parsed[c.key] = clamp(Math.round(parsed[c.key]), 0, c.maxTenths);
    });
    parsed.extra = (parsed.extra === EXTRA_TENTHS) ? EXTRA_TENTHS : 0;
    return parsed;
  }catch{
    const init = { extra: 0 };
    CRITERIOS.forEach(c => init[c.key]=0);
    return init;
  }
})();

let lastBand = null;

// Confeti √∫nico (m√°ximo) a partir de 7,0
let confettiLaunched = false;

function getBand(total){
  if(total < 5) return "red";
  if(total < 7) return "yellow";
  return "green";
}
function getColor(b){
  if(b==="red") return "#d32f2f";
  if(b==="yellow") return "#f9a825";
  return "#2e7d32";
}


function getEmoji(total){
  if (total === 10) return "üèÜ";
  if (total >= 9)  return "ü§©";
  if (total >= 8)  return "üöÄ";
  if (total >= 7)  return "üòé";
  if (total >= 6)  return "üòä";
  if (total >= 5)  return "üôÇ";
  if (total >= 4)  return "üò¨";
  if (total >= 3)  return "üòï";
  if (total >= 2)  return "üò´";
  if (total >= 1)  return "üò≠";
  return "üòµ";
}

function totalTenths(){
  const sum = CRITERIOS.reduce((acc,c)=> acc + (state[c.key]||0), 0);
  return sum + (state.extra || 0); // 0..100
}

function update(){
  const tt = totalTenths();   // 0..100 (d√©cimas)
  const total = tt / 10;      // 0..10

  totalEl.textContent = format(total);
  badge.textContent = format(total) + " / 10";
  emojiEl.textContent = getEmoji(total);

  const pct = tt / 100;
  ring.style.strokeDashoffset = C*(1-pct);
  fill.style.width = (pct*100) + "%";

  const band = getBand(total);
  const color = getColor(band);
  ring.style.stroke = color;
  fill.style.background = color;
  totalEl.style.color = color;

  // Extra UI
  extraToggle.checked = (state.extra === EXTRA_TENTHS);
  extraBadge.textContent = format((state.extra||0)/10);

  if(band==="green" && lastBand!=="green"){
    if(navigator.vibrate) navigator.vibrate([60,40,90]);
  }

  // Confeti m√°ximo a partir de 7,0 (70 d√©cimas)
  if (tt >= 70 && !confettiLaunched) {
    launchConfetti();
    confettiLaunched = true;
  }
  if (tt < 70) confettiLaunched = false;

  lastBand = band;
  localStorage.setItem(STORE, JSON.stringify(state));
}

function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  CRITERIOS.forEach(c => {
    const row = document.createElement("div");
    row.className = "row";

    const header = document.createElement("div");
    header.className = "rowHeader";

    const label = document.createElement("label");
    label.textContent = `${c.label} ( ${format(c.maxTenths/10)})`;

    const value = document.createElement("div");
    value.className = "scoreValue";
    value.textContent = format((state[c.key]||0)/10);

    header.append(label, value);

    const range = document.createElement("input");
    range.type = "range";
    range.min = 0;
    range.max = (c.maxTenths/10).toFixed(1);
    range.step = 0.1;

    const current = clamp(state[c.key]||0, 0, c.maxTenths);
    range.value = (current/10).toFixed(1);

    range.addEventListener("input", () => {
      const tenths = Math.round(parseFloat(range.value) * 10);
      state[c.key] = clamp(tenths, 0, c.maxTenths);
      value.textContent = format(state[c.key]/10);
      update();
    });

    row.append(header, range);
    list.appendChild(row);
  });

  update();
}

extraToggle.addEventListener("change", async () => {
  const turningOn = extraToggle.checked;
  state.extra = turningOn ? EXTRA_TENTHS : 0;

  // sonido SOLO al activar
  if (turningOn) playExtraSound();

  update();
});

document.getElementById("reset").addEventListener("click", () => {
  CRITERIOS.forEach(c => state[c.key] = 0);
  state.extra = 0;
  confettiLaunched = false;

  localStorage.setItem(STORE, JSON.stringify(state));
  render();
});

render();

/* ========= CONFETI (m√°ximo) ========= */
const canvas = document.getElementById("confettiCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function launchConfetti(){
  const pieces = [];
  const colors = ["#ff5252","#ffca28","#66bb6a","#42a5f5","#ab47bc","#ff7043","#26c6da","#ffffff"];

  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;

  const count = 360;
  const speedMin = 6, speedMax = 15;
  const frames = 240;

  for(let i = 0; i < count; i++){
    const angle = Math.random() * 2 * Math.PI;
    const speed = Math.random() * (speedMax - speedMin) + speedMin;

    pieces.push({
      x: centerX,
      y: centerY,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      size: Math.random() * 8 + 6,
      color: colors[(Math.random()*colors.length)|0],
      rot: Math.random() * Math.PI * 2,
      rs: (Math.random() - 0.5) * 0.35
    });
  }

  const gravity = 0.25;
  let frame = 0;

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    pieces.forEach(p=>{
      p.vy += gravity;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.rs;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.7);
      ctx.restore();
    });

    frame++;
    if(frame < frames){
      requestAnimationFrame(draw);
    } else {
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  }

  draw();
}
</script>
</body>
</html>
